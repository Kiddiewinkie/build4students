<!DOCTYPE html>
<html>
  <head>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <title>W3.CSS Template</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">

    <style>
    /* fonts */
    .hero-title {
      font-family: "Press Start 2P", monospace;
      font-size: 24px;
      font-weight: 10;
      color: #FFEA00;
    }

    body, html {
      height: 100%;
      font-family: "Press Start 2P", monospace;
      font-size: 10px;
      font-weight: 10;
      color: #818589;
    }

    .bgimg {
      background-position: center;
      background-size: cover;
      background-image: url("https://i.pinimg.com/originals/99/cd/09/99cd0925c516b5d0a740dffd03c3e0df.gif");
      min-height: 100%;
    }

    .input {
      display: none;
    }


    /* about */

    .about-title {
      color: #6E260E;
      font-size: 40px;
    }

    .about-content p {
      font-size: 21px;
      line-height: 1.75;
    }

    html {
      scroll-behavior: smooth;
    }


    .nav-shell {
      display: flex;
      justify-content: space-between; /* left group vs right group */
      align-items: center;
      padding: 8px 16px;
    }

    /* Left group stays left */
    .nav-left {
      display: flex;
      gap: 100px;              /* equal spacing between HOME/ABOUT/DIARY */
      align-items: center;
      color: #36454F;
    }

    /* Right group stays right */
    .nav-right {
      display: flex;
      gap: 12px;              /* spacing between LOG IN / SIGN UP */
      align-items: center;
      color: #36454F;
    }

    .profile-icon {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      border: 2px solid #36454F;
      background-color: #fff;
      object-fit: cover;
    }

    .profile-icon-container:hover .profile-icon {
      border-color: #6F4E37; /* Changes color on hover */
    }


    /* Modal background */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
    }

    /* Modal box */
    .modal-content {
      background: #f6f4ef;
      width: 90%;
      max-width: 400px;
      margin: 10% auto;
      padding: 32px;
      border-radius: 8px;
      position: relative;
      text-align: center;
    }

    /* --- LOGIN / SIGN UP MODAL TYPOGRAPHY --- */
    .modal-content {
      font-family: "Press Start 2P", monospace;
      font-size: 10px;          /* smaller + readable */
      line-height: 1.6;
      color: #36454F;
    }

    /* Modal title */
    .modal-content h2 {
      font-family: "Press Start 2P", monospace;
      font-size: 14px;
      font-weight: normal;
      margin-bottom: 20px;
    }

    /* Inputs */
    .modal-content input {
      font-family: "Press Start 2P", monospace;
      font-size: 9px;
      padding: 12px;
      margin-top: 12px;
    }

    /* Login / Signup button */
    .modal-content button {
      font-family: "Press Start 2P", monospace;
      font-size: 10px;
      padding: 14px 0;
    }

    /* Switch text */
    .modal-switch {
      font-size: 9px;
      line-height: 1.6;
    }

    .modal-switch span {
      font-size: 9px;
      font-weight: normal;
    }


    /* Close button */
    .close {
      position: absolute;
      top: 12px;
      right: 16px;
      font-size: 24px;
      cursor: pointer;
    }

    /* Switch text */
    .modal-switch {
      margin-top: 16px;
      font-size: 14px;
    }

    .modal-switch span {
      color: #6F4E37;
      cursor: pointer;
      font-weight: 300;
      font-size: 14px;
    }


    /* Left image */
    .about-image {
      background-image: url("https://i.pinimg.com/736x/ef/1e/63/ef1e635913352f3641fdbadfd2898bbb.jpg");
      background-size: cover;
      background-position: center;
      min-height: 100vh;
    }

    /* Right side container */
    .about-text {
      min-height: 100vh;
      display: flex;
      align-items: center;              /* vertical centering */
      justify-content: center;
      background-color: #f6f4ef;
    }

    /* Inner content with equal padding */
    .about-content {
      max-width: 500px;
      padding: 40px;                    /* equal space on all sides */
      color: #36454F;
    }

    /* Center the title horizontally */
    .about-title {
      text-align: center;
      margin-bottom: 40px;
    }

    .tablink {
      font-family: "Press Start 2P", monospace;
      font-size: 11px;          /* slightly smaller but cleaner */
      line-height: 0.1;         /* KEY FIX: adds vertical space */
      padding: 12px 0;          /* vertical breathing room */
      letter-spacing: 1px;      /* pixel fonts love spacing */
      color: #36454F;
      cursor: pointer;
    }


    .modal-content,
    .modal-content input,
    .modal-content button {
      letter-spacing: 0.3px;
    }

    .close {
      font-size: 16px;
      color: #36454F;
    }

    .modal-title {
      font-family: "Press Start 2P", monospace;
      font-size: 14px;      /* smaller & cleaner */
      font-weight: normal;
      color: #36454F;
      margin-bottom: 24px;
    }

    .pixel-body {
      font-family: "Press Start 2P", monospace;
      font-size: 10px;          /* smaller = cleaner */
      line-height: 1.9;         /* KEY: vertical breathing room */
      letter-spacing: 0.8px;
      color: #818589;
    }

    .pixel-body {
      max-width: 520px;     /* prevents long lines */
      margin: 0 auto 12px; /* centers nicely */
      text-align: center;
    }

    .submit-bar {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      margin-top: 16px;
    }

    /* Center the status */
    .submit-status {
      grid-column: 2;               /* middle column */
      justify-self: center;
      font-family: "Press Start 2P", monospace;
      font-size: 12px;
      color: #6F4E37;
      opacity: 0.85;
    }

    /* Push button to the right */
    .submit-bar button {
      grid-column: 3;
      justify-self: end;
    }



    </style>
  </head>
<body>


<div class="w3-top">
  <div class="w3-sand nav-shell">

    <!-- Left links -->
    <div class="nav-left">
      <a href="#" class="w3-bar-item w3-button">HOME</a>
      <a href="#about" class="w3-bar-item w3-button">ABOUT</a>
      <a href="diary.html" class="w3-bar-item w3-button">DIARY</a>
      <a href="settings.html" class="w3-bar-item w3-button">SETTINGS</a>
    </div>

    <!-- Right buttons -->
    <div class="nav-right">
  <div id="loggedOutUI" style="display: flex; gap: 12px;">
    <a href="javascript:void(0)" class="w3-bar-item w3-button w3-border w3-round" onclick="openModal('loginModal')">LOG IN</a>
    <a href="javascript:void(0)" class="w3-bar-item w3-button w3-border w3-round" onclick="openModal('signupModal')">SIGN UP</a>
  </div>

  <div id="loggedInUI" style="display: none; align-items: center; gap: 15px;">
    <span id="userNameDisplay" style="color: #36454F; font-size: 10px;"></span>
    <div class="profile-icon-container" onclick="location.href='settings.html'" style="cursor: pointer;">
      <img id="userIcon" src="https://api.dicebear.com/7.x/pixel-art/svg?seed=Felix" alt="Avatar" class="profile-icon">
    </div>
    <a href="javascript:void(0)" onclick="handleLogout()" class="w3-button w3-tiny w3-border w3-round">LOGOUT</a>
  </div>
</div>


  </div>
</div>




<!-- Header with image -->
<header class="bgimg w3-display-container w3-grayscale-min" id="home">

  <div class="w3-display-middle w3-center" style="width:90%; max-width:700px;">

    <span id="dailyPrompt" class="hero-title" style="font-size: 40px; display:block; margin-bottom:24px;">
      How was your day?<br>
    </span>

    <!-- INPUT CONTAINER -->
    <div class="w3-card w3-padding w3-sand">

      <div class="w3-row w3-center w3-padding">

        <a href="javascript:void(0)" onclick="openinput(event, 'Write');" id="myLink">
          <div class="w3-col s4 tablink">Write</div>
        </a>
        <a href="javascript:void(0)" onclick="openinput(event, 'Speak');">
          <div class="w3-col s4 tablink">Speak</div>
        </a>
        <a href="javascript:void(0)" onclick="openinput(event, 'Record');">
          <div class="w3-col s4 tablink">Record</div>
        </a>

      </div>

      <div id="Write" class="w3-container input w3-padding-16">
        <textarea
        id="writeInput"
        class="w3-input w3-border"
        placeholder="Start typing..."
        style="height:150px; resize:none"
        ></textarea>

        <div class="submit-bar">
          <span id="writeStatus" class="submit-status"></span>

          <button id="submitWrite" type="button"
                  class="w3-button w3-dark-grey w3-round">
            Submit
          </button>
        </div>



      </div>

      <div id="Speak" class="w3-container input w3-padding-16">

        <p class="pixel-body" style="margin-top:0;">Record a voice note.</p>

        <div class="w3-bar">
          <button id="startRecBtn" class="w3-button w3-dark-grey w3-round">Start</button>
          <button id="pauseRecBtn" class="w3-button w3-light-grey w3-round" disabled>Pause</button>
          <button id="resumeRecBtn" class="w3-button w3-light-grey w3-round" disabled>Resume</button>
          <button id="stopRecBtn" class="w3-button w3-black w3-round" disabled>Stop</button>
        </div>

        <p id="recStatus" class="w3-small w3-text-grey" style="margin-top:12px;">Not recording</p>

        <audio id="playback" controls style="width:100%; display:none; margin-top:12px;"></audio>

        <!-- Button row -->
        <div style="display:flex; justify-content:flex-end; margin-top:12px;">
          <button id="submitSpeak" type="button" class="w3-button w3-dark-grey w3-round">Submit</button>
        </div>

      </div>

      <div id="Record" class="w3-container input w3-padding-16">
        <p class="pixel-body" style="margin-top:0;">Record a video note.<br> 
          (Video starts immediately after pressing "Start".)
          </p>

        <!-- Live camera preview -->
        <video id="videoPreview" autoplay playsinline muted
              style="width:100%; border-radius:8px; display:none;"></video>

        <!-- Playback of recorded video -->
        <video id="videoPlayback" controls
              style="width:100%; border-radius:8px; display:none; margin-top:12px;"></video>

        <div class="w3-bar" style="margin-top:12px;">
          <button id="startVidBtn" class="w3-button w3-dark-grey w3-round">Start</button>
          <button id="pauseVidBtn" class="w3-button w3-light-grey w3-round" disabled>Pause</button>
          <button id="resumeVidBtn" class="w3-button w3-light-grey w3-round" disabled>Resume</button>
          <button id="stopVidBtn" class="w3-button w3-black w3-round" disabled>Stop</button>
        </div>

        <p id="vidStatus" class="w3-small w3-text-grey" style="margin-top:12px;">Not recording</p>
        
        <!-- Button row -->
        <div style="display:flex; justify-content:flex-end; margin-top:12px;">
          <button id="submitRecord" type="button" class="w3-button w3-dark-grey w3-round">Submit</button>
        </div>

      </div>

    </div>

  </div>

</header>


<!-- Add a background color and large text to the whole page -->
<div class="w3-sand w3-large">


<!-- About Section -->
<div class="w3-row" id="about" style="min-height:100vh;">

  <!-- Left: Image -->
  <div class="w3-col m6 w3-hide-small about-image"></div>

  <!-- Right: Text -->
  <div class="w3-col m6 about-text">
    <div class="about-content">

      <h1 class="hero-title about-title">About</h1>

      <p class="w3-large">
        We created this website to give students a space to share their feelings. 
        Go on your self-improvement journey by looking through your reviews.
      </p>

      <p class="w3-text-grey">
        Life can be daunting. Start writing today.
      </p>

    </div>
  </div>

<div id="loginModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('loginModal')">&times;</span>
    <h2 class="modal-title">Log In</h2>

    <input id="loginEmail" class="w3-input w3-border" type="email" placeholder="Email">
    <input id="loginPassword" class="w3-input w3-border" type="password" placeholder="Password" style="margin-top:12px;">

    <button onclick="handleLogin()" class="w3-button w3-dark-grey w3-margin-top w3-block">
      Log In
    </button>

    <p class="modal-switch">
      Don't have an account?
      <span onclick="switchToSignup()">Sign up here</span>
    </p>
  </div>
</div>

<div id="signupModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('signupModal')">&times;</span>
    <h2 class="modal-title">Sign Up</h2>

    <input id="signupName" class="w3-input w3-border" type="text" placeholder="Name">
    <input id="signupEmail" class="w3-input w3-border" type="email" placeholder="Email" style="margin-top:12px;">
    <input id="signupPassword" class="w3-input w3-border" type="password" placeholder="Password" style="margin-top:12px;">

    <button onclick="handleSignup()" class="w3-button w3-dark-grey w3-margin-top w3-block">
      Create Account
    </button>

    <p class="modal-switch">
      Already have an account?
      <span onclick="switchToLogin()">Log in here</span>
    </p>
  </div>
</div>

<!-- End page content -->
</div>

<script type="module">
// Add this import at the top of your module script
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

// --- 2. CONFIGURATION ---
const firebaseConfig = { 
    apiKey: "AIzaSyD9tMCOvupw_2RD46jWI0RMHpnHC9eLgME", // Your Firebase API Key
    authDomain: "voicediary-ec3cf.firebaseapp.com",
    projectId: "voicediary-ec3cf",
    storageBucket: "voicediary-ec3cf.appspot.com",
    messagingSenderId: "912058113496",
    appId: "1:912058113496:web:921482baa733ad194726ad"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Initialize Gemini with the correct stable model
const genAI = new GoogleGenerativeAI("AIzaSyCuNH6iGMgEqW1ZxmvMmhHmIxKCe3w9kwc"); // Your Gemini API Key
const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

// --- 3. VOICE ANALYSIS FUNCTION (THE MISSING PIECE!) ---
window.analyzeVoiceWithGemini = async (audioBlob) => {
    try {
        console.log("ðŸŽ¤ Starting Voice Analysis with Gemini...");
        const reader = new FileReader();
        
        return new Promise((resolve, reject) => {
            reader.readAsDataURL(audioBlob);
            reader.onloadend = async () => {
                const base64Data = reader.result.split(',')[1];

                const prompt = `I am recording a voice diary entry. 
                                Listen to my tone, pace, and emotion in the audio.
                                Provide a concise, empathetic summary of how I am feeling.
                                Start with "You seem..." or "You sound..."
                                Keep it under 20 words and be supportive.`;

                const result = await model.generateContent([
                    {
                        inlineData: {
                            data: base64Data,
                            mimeType: audioBlob.type
                        }
                    },
                    { text: prompt }
                ]);

                const response = await result.response;
                console.log("âœ… Voice Analysis Complete");
                resolve(response.text());
            };
            reader.onerror = (error) => {
                console.error("File Reading Error:", error);
                reject("Could not process audio file.");
            };
        });
    } catch (error) {
        console.error("Gemini API Error:", error);
        return "I'm having trouble connecting to the AI right now, but your voice note is saved.";
    }
};

// --- 4. MULTIMODAL AI FUNCTION (Video + Face) ---
window.getMultimodalSummary = async (faceEmotions, audioBlob) => {
    try {
        console.log("ðŸŽ¥ Starting Multimodal Analysis...");
        const reader = new FileReader();
        
        return new Promise((resolve, reject) => {
            reader.readAsDataURL(audioBlob);
            reader.onloadend = async () => {
                const base64Data = reader.result.split(',')[1];

                // Format facial data into a readable string
                // e.g., "happy: 80%, sad: 2%..."
                const faceString = Object.entries(faceEmotions)
                    .map(([emotion, val]) => `${emotion}: ${val}%`)
                    .join(", ");

                const prompt = `I am recording a video diary. 
                                During this recording, my facial expressions were: ${faceString}.
                                Listen to the audio tone and combine it with these visual cues.
                                Provide a concise, empathetic summary of how I am feeling right now. 
                                Start with "You seem..."`;

                const result = await model.generateContent([
                    {
                        inlineData: {
                            data: base64Data,
                            mimeType: audioBlob.type
                        }
                    },
                    { text: prompt }
                ]);

                const response = await result.response;
                console.log("âœ… Gemini Analysis Complete");
                resolve(response.text());
            };
            reader.onerror = (error) => {
                console.error("File Reading Error:", error);
                reject("Could not process audio file.");
            };
        });
    } catch (error) {
        console.error("Gemini API Error:", error);
        return "I'm having trouble connecting to the AI right now, but your data is safe.";
    }
};

// --- 5. FIRESTORE SAVE FUNCTIONS ---

// Save Text Diary Entries
window.saveWriteToFirestore = async (text) => {
    const user = auth.currentUser;
    if (!user) return console.error("No user logged in.");

    try {
        await addDoc(collection(db, "diary_entries"), {
            userId: user.uid,
            userName: user.displayName || user.email,
            type: "write",
            content: text,
            timestamp: serverTimestamp() 
        });
        console.log("Written entry saved!");
    } catch (e) { console.error("Error saving write:", e); }
};

// Save Multimodal Analysis (Voice + Face Result)
window.saveAnalysisToFirestore = async (dataPayload) => {
    const user = auth.currentUser;
    if (!user) return console.error("No user logged in.");

    try {
        // We create a flexible object that can hold the summary string OR the full object
        const docData = {
            userId: user.uid,
            userName: user.displayName || user.email,
            timestamp: serverTimestamp(),
            // Spread the dataPayload if it's an object (containing faceData, voiceSummary, etc.)
            ...(typeof dataPayload === 'object' ? dataPayload : { analysis: dataPayload })
        };

        await addDoc(collection(db, "voice_analyses"), docData);
        console.log("Analysis saved to Firestore!");
    } catch (e) { console.error("Error saving analysis:", e); }
};

// --- 6. AUTHENTICATION LOGIC ---

// Listen for login state changes
onAuthStateChanged(auth, (user) => {
    const loggedOutUI = document.getElementById('loggedOutUI');
    const loggedInUI = document.getElementById('loggedInUI');
    const nameDisplay = document.getElementById('userNameDisplay');
    const userIcon = document.getElementById('userIcon');

    if (user) {
        if (loggedOutUI) loggedOutUI.style.display = 'none';
        if (loggedInUI) loggedInUI.style.display = 'flex';
        
        // Update Name
        if (nameDisplay) {
            nameDisplay.textContent = user.displayName || user.email.split('@')[0].toUpperCase();
        }
        // Update Icon
        if (userIcon && user.photoURL) {
            userIcon.src = user.photoURL;
        }
    } else {
        if (loggedOutUI) loggedOutUI.style.display = 'flex';
        if (loggedInUI) loggedInUI.style.display = 'none';
    }
});

// Global Auth Functions (attached to window for buttons)
window.handleLogin = async () => {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    if (!email || !password) return alert("Please enter email and password");

    try {
        await signInWithEmailAndPassword(auth, email, password);
        alert("Welcome back!");
        const modal = document.getElementById('loginModal');
        if (modal) modal.style.display = 'none';
    } catch (error) { alert("Login Error: " + error.message); }
};

window.handleSignup = async () => {
    const email = document.getElementById('signupEmail').value;
    const password = document.getElementById('signupPassword').value;
    if (!email || !password) return alert("Please enter email and password");

    try {
        await createUserWithEmailAndPassword(auth, email, password);
        alert("Account created!");
        const modal = document.getElementById('signupModal');
        if (modal) modal.style.display = 'none';
    } catch (error) { alert("Signup Error: " + error.message); }
};

window.handleLogout = () => {
    signOut(auth)
        .then(() => alert("Logged out!"))
        .catch(e => console.error(e));
};
</script>

<script>

// ---------- UI: tabs ----------
function openinput(evt, inputName) {
  const panels = document.getElementsByClassName("input");
  for (let i = 0; i < panels.length; i++) panels[i].style.display = "none";

  const tabs = document.getElementsByClassName("tablink");
  for (let i = 0; i < tabs.length; i++) tabs[i].className = tabs[i].className.replace(" w3-dark-grey", "");

  document.getElementById(inputName).style.display = "block";
  evt.currentTarget.firstElementChild.className += " w3-dark-grey";
}
document.getElementById("myLink").click();

// ---------- UI: modals ----------
function openModal(id) { document.getElementById(id).style.display = "block"; }
function closeModal(id) { document.getElementById(id).style.display = "none"; }
function switchToSignup() { closeModal("loginModal"); openModal("signupModal"); }
function switchToLogin() { closeModal("signupModal"); openModal("loginModal"); }

window.onclick = function (event) {
  if (event.target.classList.contains("modal")) event.target.style.display = "none";
};

// ---------- localStorage helpers ----------
function pad2(n) { return String(n).padStart(2, "0"); }
function toYMD(date) { return `${date.getFullYear()}-${pad2(date.getMonth()+1)}-${pad2(date.getDate())}`; }
function toHM(date) { return `${pad2(date.getHours())}:${pad2(date.getMinutes())}`; }

function getDiaryEntries() {
  return JSON.parse(localStorage.getItem("diaryEntries")) || [];
}
function saveDiaryEntry(entry) {
  const all = getDiaryEntries();
  all.push(entry);
  localStorage.setItem("diaryEntries", JSON.stringify(all));
}

// ---------- IndexedDB (store blobs) ----------
const DB_NAME = "DiaryDB";
const DB_VERSION = 1;
const STORE_MEDIA = "media";

function openDiaryDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);

    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains(STORE_MEDIA)) db.createObjectStore(STORE_MEDIA);
    };

    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function idbPutBlob(key, blob) {
  const db = await openDiaryDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_MEDIA, "readwrite");
    tx.objectStore(STORE_MEDIA).put(blob, key);
    tx.oncomplete = () => resolve();
    tx.onerror = () => reject(tx.error);
  });
}

function makeId() {
  return (crypto.randomUUID ? crypto.randomUUID() : ("id_" + Date.now() + "_" + Math.random().toString(16).slice(2)));
}

// ---------- WRITE: submit ----------
document.getElementById("submitWrite").addEventListener("click", async () => {
  const writeInput = document.getElementById("writeInput");
  const status = document.getElementById("writeStatus");
  const text = (writeInput.value || "").trim();
  if (!text) return;

  // Check if function exists
  if (typeof window.saveWriteToFirestore === 'function') {
      await window.saveWriteToFirestore(text);
      status.textContent = "Saved to Cloud!";
  } else {
      status.textContent = "Error: Firebase not loaded";
      console.error("saveWriteToFirestore is not defined");
      return; 
  }

  // Local Storage backup
  const now = new Date();
  saveDiaryEntry({ date: toYMD(now), time: toHM(now), type: "write", text });
  
  writeInput.value = "";
  setTimeout(() => { status.textContent = ""; }, 2000);
});

// ---------- SPEAK: recording ----------
let mediaRecorder = null;
let audioChunks = [];
let stream = null;
let audioBlob = null;

const startBtn = document.getElementById("startRecBtn");
const pauseBtn = document.getElementById("pauseRecBtn");
const resumeBtn = document.getElementById("resumeRecBtn");
const stopBtn = document.getElementById("stopRecBtn");
const statusEl = document.getElementById("recStatus");
const playback = document.getElementById("playback");

function setStatus(text) { statusEl.textContent = text; }

async function startRecording() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    audioChunks = [];
    audioBlob = null;

    mediaRecorder = new MediaRecorder(stream);

    mediaRecorder.ondataavailable = (e) => {
      if (e.data && e.data.size > 0) audioChunks.push(e.data);
    };

    mediaRecorder.onstart = () => {
      setStatus("Recording...");
      startBtn.disabled = true;
      pauseBtn.disabled = false;
      stopBtn.disabled = false;
      resumeBtn.disabled = true;

      playback.style.display = "none";
      playback.src = "";
    };

    mediaRecorder.onpause = () => {
      setStatus("Paused");
      pauseBtn.disabled = true;
      resumeBtn.disabled = false;
    };

    mediaRecorder.onresume = () => {
      setStatus("Recording...");
      pauseBtn.disabled = false;
      resumeBtn.disabled = true;
    };

    mediaRecorder.onstop = () => {
      setStatus("Saved (preview below)");

      startBtn.disabled = false;
      pauseBtn.disabled = true;
      resumeBtn.disabled = true;
      stopBtn.disabled = true;

      if (stream) stream.getTracks().forEach(t => t.stop());

      audioBlob = new Blob(audioChunks, { type: "audio/webm" });
      playback.src = URL.createObjectURL(audioBlob);
      playback.style.display = "block";
      playback.load();
    };

    mediaRecorder.start();
  } catch (err) {
    console.error(err);
    setStatus("Microphone permission blocked or unavailable.");
  }
}

function pauseRecording() {
  if (mediaRecorder && mediaRecorder.state === "recording") mediaRecorder.pause();
}
function resumeRecording() {
  if (mediaRecorder && mediaRecorder.state === "paused") mediaRecorder.resume();
}
function stopRecording() {
  if (mediaRecorder && (mediaRecorder.state === "recording" || mediaRecorder.state === "paused")) mediaRecorder.stop();
}

startBtn.addEventListener("click", startRecording);
pauseBtn.addEventListener("click", pauseRecording);
resumeBtn.addEventListener("click", resumeRecording);
stopBtn.addEventListener("click", stopRecording);

// ---------- SPEAK: submit (NOW WITH REAL AI!) ----------
document.getElementById("submitSpeak").addEventListener("click", async () => {
  if (!audioBlob) return;
  const status = document.getElementById("recStatus");
  status.textContent = "ðŸ¤– Gemini is analyzing your voice...";

  // 1. Get Real AI Analysis
  let analysisResult;
  if (window.analyzeVoiceWithGemini) {
      analysisResult = await window.analyzeVoiceWithGemini(audioBlob);
  } else {
      analysisResult = "Voice saved, but AI is still warming up.";
  }

  // 2. Save to Firestore (Cloud)
  if (window.saveAnalysisToFirestore) {
      await window.saveAnalysisToFirestore(analysisResult);
  }

  // 3. Local Storage backup (for your Diary page)
  const now = new Date();
  const mediaId = makeId();
  await idbPutBlob(mediaId, audioBlob);
  
  saveDiaryEntry({ 
    date: toYMD(now), 
    time: toHM(now), 
    type: "speak", 
    mediaId, 
    analysis: analysisResult 
  });
  
  // UI Reset
  playback.pause();
  audioBlob = null;
  status.textContent = `âœ… AI: "${analysisResult}"`;
  
  setTimeout(() => { status.textContent = "Not recording"; }, 5000);
});

// --- FACE API & RECORDING VARIABLES ---
let videoRecorder = null;
let videoChunks = [];
let videoStream = null;
let videoBlob = null;
let faceResults = []; 
let faceModelLoaded = false;

// --- ADD THIS MISSING FUNCTION ---
const vidStatus = document.getElementById("vidStatus");
function setVidStatus(text) { 
    if (vidStatus) vidStatus.textContent = text; 
}

// Load Face API Models on Page Load
window.addEventListener('load', async () => {
    const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model';
    await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
    await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
    faceModelLoaded = true;
    console.log("Face Models Loaded");
});

// --- HELPER: Calculate Average Emotion ---
function calculateAverageEmotions(results) {
    if (!results || results.length === 0) return { neutral: 100 };
    
    const totals = { happy: 0, sad: 0, angry: 0, surprised: 0, fearful: 0, disgusted: 0, neutral: 0 };
    
    results.forEach(r => {
        Object.keys(totals).forEach(k => totals[k] += (r[k] || 0));
    });

    const count = results.length;
    Object.keys(totals).forEach(k => {
        totals[k] = Math.round((totals[k] / count) * 100);
    });
    
    return totals;
}

// --- HELPER: Detection Loop ---
async function trackEmotions() {
    if (!videoRecorder || videoRecorder.state !== "recording") return;

    // Detect faces
    const videoEl = document.getElementById("videoPreview");
    if (videoEl && !videoEl.paused && !videoEl.ended) {
        const detection = await faceapi
            .detectSingleFace(videoEl, new faceapi.TinyFaceDetectorOptions())
            .withFaceExpressions();

        if (detection) {
            faceResults.push(detection.expressions);
        }
    }
    
    setTimeout(trackEmotions, 100); 
}

// ---------- START RECORDING (Modified) ----------
const startVidBtn = document.getElementById("startVidBtn");
const videoPreview = document.getElementById("videoPreview");
const videoPlayback = document.getElementById("videoPlayback");

document.getElementById("startVidBtn").addEventListener("click", async () => {
    if (!faceModelLoaded) {
        alert("Please wait a moment for AI models to load...");
        return;
    }

    try {
        videoStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        videoPreview.srcObject = videoStream;
        videoPreview.style.display = "block";
        videoPlayback.style.display = "none";

        videoRecorder = new MediaRecorder(videoStream);
        videoChunks = [];
        faceResults = []; 

        videoRecorder.ondataavailable = (e) => videoChunks.push(e.data);
        
        videoRecorder.onstart = () => {
            setVidStatus("Recording... (AI is watching)");
            document.getElementById("startVidBtn").disabled = true;
            document.getElementById("stopVidBtn").disabled = false;
            
            trackEmotions();
        };

        videoRecorder.onstop = () => {
            setVidStatus("Processing AI Summary...");
            document.getElementById("startVidBtn").disabled = false;
            document.getElementById("stopVidBtn").disabled = true;
            
            videoBlob = new Blob(videoChunks, { type: "video/webm" });
            videoPreview.srcObject = null;
            videoPreview.style.display = "none";
            
            videoPlayback.src = URL.createObjectURL(videoBlob);
            videoPlayback.style.display = "block";
            
            videoStream.getTracks().forEach(t => t.stop());
        };

        videoRecorder.start();

    } catch (err) {
        console.error(err);
        setVidStatus("Camera Error");
    }
});

document.getElementById("stopVidBtn").addEventListener("click", () => {
    if (videoRecorder) videoRecorder.stop();
});

// ---------- RECORD: SUBMIT (The Big Change) ----------
document.getElementById("submitRecord").addEventListener("click", async () => {
    if (!videoBlob) return;
    const status = document.getElementById("vidStatus");
    status.textContent = "ðŸŽ¥ Gemini is analyzing Video + Face data...";

    // 1. Calculate the 'Average Face' from the recording
    const avgFace = calculateAverageEmotions(faceResults);
    console.log("Average Face Data:", avgFace);

    // 2. Send Face Data + Audio to Gemini (defined in main.js)
    let analysisResult;
    if (window.getMultimodalSummary) {
        analysisResult = await window.getMultimodalSummary(avgFace, videoBlob);
    } else {
        analysisResult = "AI functions not loaded.";
    }

    // 3. Save to Firestore with the full data object
    if (window.saveAnalysisToFirestore) {
        await window.saveAnalysisToFirestore({
            analysis: analysisResult,
            faceData: avgFace,
            type: "video_entry"
        });
    }

    const now = new Date();
    const mediaId = makeId();
    await idbPutBlob(mediaId, videoBlob);

    saveDiaryEntry({ 
        date: toYMD(now), 
        time: toHM(now), 
        type: "record", 
        mediaId,
        analysis: analysisResult 
    });

    status.textContent = "âœ… Saved! " + analysisResult;
    videoBlob = null;
});

async function ensurePermission() {
  if (!("Notification" in window)) return false;
  if (Notification.permission === "granted") return true;
  if (Notification.permission === "denied") return false;
  const p = await Notification.requestPermission();
  return p === "granted";
}

function scheduleDailyAt(hour, minute, title, body) {
  const scheduleOnce = () => {
    setTimeout(() => {
      new Notification(title, { body });
      scheduleOnce(); 
    }, msUntilNext(hour, minute));
  };
  scheduleOnce();
}

async function startInPageReminders() {
  const ok = await ensurePermission();
  if (!ok) return;

  scheduleDailyAt(9, 0, "Morning check-in", "How are you feeling today?");
  scheduleDailyAt(21, 0, "Night reflection", "Want to write a quick diary entry?");
}


// --- LOAD RANDOM PROMPT FROM SETTINGS ---
window.addEventListener('DOMContentLoaded', () => {
    const promptElement = document.getElementById("dailyPrompt");
    if (!promptElement) return;

    const PROMPTS_KEY = "customPrompts";
    const DEFAULT_PROMPTS = [
      "How was your day?",
      "Whatâ€™s on your mind right now?",
      "What are you grateful for today?",
      "What did you learn today?"
    ];

    let prompts = [];
    try {
        const raw = localStorage.getItem(PROMPTS_KEY);
        prompts = raw ? JSON.parse(raw) : DEFAULT_PROMPTS;
    } catch (e) {
        prompts = DEFAULT_PROMPTS;
    }

    if (!Array.isArray(prompts) || prompts.length === 0) {
        prompts = DEFAULT_PROMPTS;
    }

    const randomPrompt = prompts[Math.floor(Math.random() * prompts.length)];

    promptElement.textContent = randomPrompt;
});

</script>



</body>
</html>
